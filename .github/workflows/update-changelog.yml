name: Update changelog

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  update-changelog:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog entry
        shell: bash
        run: |
          bash scripts/update_changelog.sh

      - name: Create and push branch with signed changelog commit
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if git diff --quiet -- CHANGELOG.md; then
            echo "No changelog updates to commit."
            exit 0
          fi

          BRANCH="changelog-update-${{ github.run_number }}"
          FILE_TO_COMMIT="CHANGELOG.md"
          MESSAGE="Update changelog"

          # Create the branch from main
          gh api repos/${{ github.repository }}/git/refs \
            -f ref="refs/heads/${BRANCH}" \
            -f sha="$(git rev-parse main)"

          # Get the current SHA of the file on main (if it exists)
          SHA=$(git rev-parse main:$FILE_TO_COMMIT)

          # Encode the file content as base64
          CONTENT=$(base64 -w 0 $FILE_TO_COMMIT)

          # Use the REST API to commit changes (automatically signed)
          gh api --method PUT repos/${{ github.repository }}/contents/$FILE_TO_COMMIT \
            --field message="$MESSAGE" \
            --field content="$CONTENT" \
            --field encoding="base64" \
            --field branch="$BRANCH" \
            --field sha="$SHA"

          # Create the PR
          gh pr create \
            --title "Update changelog" \
            --body "This PR updates the changelog with recent changes.\n\nAuto-generated by workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --base main \
            --head "${BRANCH}"
